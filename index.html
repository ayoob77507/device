<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام الموظفين — لوحة تحكم</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --blue-700:#0d6efd; --blue-500:#2b8dfc; --bg:#f4f8ff; --card:#ffffff;
      --muted:#6c757d; --success:#198754;
    }
    body{background:var(--bg);font-family:Inter, 'Segoe UI', Tahoma, sans-serif;color:#222}
    .container-app{max-width:1100px;margin:28px auto}
    /* Header */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:56px;height:56px;background:linear-gradient(180deg,var(--blue-700),#0b5ed7);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .brand h3{margin:0;font-size:20px}

    /* Cards */
    .card-main{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(13,110,253,0.08)}

    /* Table */
    table thead{background:var(--blue-700);color:#fff}
    table th, table td{vertical-align:middle}
    .action-btn{border-radius:6px;padding:6px 8px;font-size:13px}

    /* Search and controls */
    .controls{display:flex;gap:12px;align-items:center}
    .controls .form-select, .controls .form-control{min-width:120px}

    /* Modal style */
    .modal-header{background:linear-gradient(90deg,var(--blue-700),var(--blue-500));color:#fff}
    .modal .form-control{border-radius:6px}

    /* Login */
    #loginView{min-height:100vh;display:flex;align-items:center;justify-content:center}
    .login-card{width:420px;background:linear-gradient(180deg,#ffffff, #f8fbff);border-radius:12px;padding:26px;box-shadow:0 10px 30px rgba(13,110,253,0.08)}
    .login-card h2{margin-bottom:6px}
    .login-illustration{width:82px;height:82px;border-radius:18px;background:linear-gradient(180deg,var(--blue-700),#1a5bd8);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;color:#fff}

    footer{text-align:center;margin-top:28px;color:var(--muted)}

    @media (max-width:720px){.container-app{padding:12px}.controls{flex-direction:column;align-items:stretch}.brand h3{font-size:18px}}
  </style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="loginView">
  <div class="login-card text-center">
    <div class="login-illustration"><i class="fa fa-user-lock fa-2x"></i></div>
    <h2>تسجيل دخول</h2>
    <p class="text-muted">أدخل بياناتك للوصول إلى لوحة التحكم</p>
    <div class="mb-3 input-group" dir="ltr">
      <span class="input-group-text"><i class="fa fa-user"></i></span>
      <input id="loginUser" class="form-control" placeholder="Username">
    </div>
    <div class="mb-3 input-group" dir="ltr">
      <span class="input-group-text"><i class="fa fa-lock"></i></span>
      <input id="loginPass" type="password" class="form-control" placeholder="Password">
    </div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><input id="rememberMe" type="checkbox"> <label for="rememberMe">تذكرني</label></div>
      <a href="#" onclick="alert('ميزة استعادة كلمة المرور غير مفعلة');return false">نسيت كلمة المرور؟</a>
    </div>
    <button id="btnLogin" class="btn btn-primary w-100 mb-2" onclick="doLogin()">Log in</button>
    <div id="loginMsg" class="text-danger small mb-2"></div>
    <footer>JNC Edukasi@2024. All Rights Reserved.</footer>
  </div>
</div>

<!-- APP VIEW -->
<div id="appView" style="display:none">
  <div class="container-app">
    <div class="topbar">
      <div class="brand"><div class="logo">J</div><h3>EMPLOYEE DATA</h3></div>
      <div class="controls">
        <div class="d-flex align-items-center">
          <label class="me-2">عرض</label>
          <select id="rowsPerPage" class="form-select form-select-sm">
            <option>5</option><option>10</option><option>25</option>
          </select>
        </div>
        <input id="globalSearch" class="form-control form-control-sm" placeholder="Search" style="width:260px">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editModal"><i class="fa fa-plus me-2"></i> New Data</button>
        <button class="btn btn-danger" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="card-main">
      <table class="table table-bordered table-striped" id="empTable">
        <thead>
          <tr>
            <th>Emp_ID</th>
            <th>Name</th>
            <th>Gender</th>
            <th>Address</th>
            <th>Email</th>
            <th>Contact</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div id="infoText" class="text-muted">Showing 0 to 0 of 0 entries</div>
        <div>
          <button class="btn btn-light btn-sm me-1" id="prevPage">Previous</button>
          <nav class="d-inline-block"><ul id="pagination" class="pagination pagination-sm mb-0"></ul></nav>
          <button class="btn btn-light btn-sm ms-1" id="nextPage">Next</button>
        </div>
      </div>
    </div>

    <div style="height:24px"></div>
    <footer>JNC Edukasi@2024. All Rights Reserved.</footer>
  </div>
</div>

<!-- EDIT / ADD Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add / Edit Employee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="empForm">
          <div class="row g-3">
            <div class="col-md-6"><label>Emp-ID</label><input id="f_empid" class="form-control"></div>
            <div class="col-md-6"><label>Contact</label><input id="f_contact" class="form-control"></div>
            <div class="col-md-6"><label>Name</label><input id="f_name" class="form-control"></div>
            <div class="col-md-6"><label>Organization</label><input id="f_org" class="form-control"></div>
            <div class="col-md-6"><label>Gender</label><select id="f_gender" class="form-control"><option>Male</option><option>Female</option></select></div>
            <div class="col-md-6"><label>Department</label><input id="f_dept" class="form-control"></div>
            <div class="col-md-6"><label>Address</label><input id="f_address" class="form-control"></div>
            <div class="col-md-6"><label>Position</label><input id="f_position" class="form-control"></div>
            <div class="col-md-6"><label>Email</label><input id="f_email" type="email" class="form-control"></div>
            <div class="col-md-6"><label>Website</label><input id="f_website" class="form-control"></div>
          </div>
          <input type="hidden" id="formMode" value="add">
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-primary" id="saveBtn">Save</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbxjldsclHDbDDnWAsvG2WNr9N_p_mj3-zjF-4xBoQMXap88xKQj0H4xRKzaSSu6m-0bTA/exec'; // ضع رابط Web App هنا
let employees = [];
let filtered = [];
let currentPage = 1;
let rowsPerPage = 5;
let editingEmpId = null;

function qs(s){return document.querySelector(s)}

// Login
function doLogin(){
  const u = qs('#loginUser').value.trim();
  const p = qs('#loginPass').value.trim();
  if(!u || !p){qs('#loginMsg').innerText='الرجاء إدخال اسم المستخدم وكلمة المرور';return}
  fetch(`${API_BASE}?mode=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
    .then(r=>r.text()).then(txt=>{
      if(txt.trim()==='ok'){
        qs('#loginView').style.display='none'; qs('#appView').style.display='block'; loadData();
      } else qs('#loginMsg').innerText='بيانات الدخول خاطئة';
    }).catch(e=>{qs('#loginMsg').innerText='خطأ في الاتصال'})
}

function loadData(){
  fetch(`${API_BASE}?mode=read`)
  .then(r => r.text())
  .then(txt => {
    let data;
    try { data = JSON.parse(txt); }
    catch(e){ console.error('Failed to parse read response', txt); data = []; }
    employees = Array.isArray(data) ? data : [];
    filtered = [...employees];
    currentPage = 1;
    render();
  })
  .catch(e => { console.error(e); alert('فشل تحميل البيانات'); });

function render(){
  const tbody = qs('#empTable tbody'); tbody.innerHTML='';
  const total = filtered.length; const start=(currentPage-1)*rowsPerPage; const end=Math.min(start+rowsPerPage,total);
  const slice = filtered.slice(start,end);
  slice.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(row.EmpID||'')}</td>
      <td>${escapeHtml(row.Name||'')}</td>
      <td>${escapeHtml(row.Gender||'')}</td>
      <td>${escapeHtml(row.Address||'')}</td>
      <td>${escapeHtml(row.Email||'')}</td>
      <td>${escapeHtml(row.Contact||'')}</td>
      <td>
        <button class='btn btn-success btn-sm action-btn me-1' onclick='openEdit("${encodeURIComponent(row.EmpID)}")'><i class="fa fa-edit"></i></button>
        <button class='btn btn-danger btn-sm action-btn me-1' onclick='confirmDelete("${encodeURIComponent(row.EmpID)}")'><i class="fa fa-trash"></i></button>
        <button class='btn btn-info btn-sm action-btn' onclick='openView("${encodeURIComponent(row.EmpID)}")'><i class="fa fa-eye"></i></button>
      </td>`;
    tbody.appendChild(tr);
  });
  qs('#infoText').innerText = `Showing ${total? start+1:0} to ${end} of ${total} entries`;
  renderPagination(Math.ceil(total/rowsPerPage)||1);
}

function renderPagination(pages){ const ul = qs('#pagination'); ul.innerHTML=''; for(let p=1;p<=pages;p++){ const li=document.createElement('li'); li.className='page-item '+(p===currentPage?'active':''); li.innerHTML=`<a class='page-link' href='#' onclick='goPage(${p});return false;'>${p}</a>`; ul.appendChild(li);} }
function goPage(p){ currentPage=p; render(); }
qs('#globalSearch').addEventListener('input', ()=>{ const t=qs('#globalSearch').value.trim().toLowerCase(); if(!t){ filtered=[...employees]; currentPage=1; render(); return } filtered = employees.filter(r=> JSON.stringify(r).toLowerCase().includes(t)); currentPage=1; render(); });
qs('#rowsPerPage').addEventListener('change', ()=>{ rowsPerPage = +qs('#rowsPerPage').value; currentPage=1; render(); });
qs('#prevPage').addEventListener('click', ()=>{ if(currentPage>1){currentPage--; render();}});
qs('#nextPage').addEventListener('click', ()=>{ if(currentPage < Math.ceil(filtered.length/rowsPerPage)){currentPage++; render();}});

function openEdit(empIdEnc){ const id=decodeURIComponent(empIdEnc); const rec = employees.find(r=> r.EmpID==id); if(!rec) return alert('Not found'); editingEmpId=id; qs('#f_empid').value=rec.EmpID; qs('#f_empid').disabled=true; qs('#f_name').value=rec.Name||''; qs('#f_gender').value=rec.Gender||'Male'; qs('#f_address').value=rec.Address||''; qs('#f_email').value=rec.Email||''; qs('#f_contact').value=rec.Contact||''; qs('#f_org').value=rec.Organization||''; qs('#f_dept').value=rec.Department||''; qs('#f_position').value=rec.Position||''; qs('#f_website').value=rec.Website||''; qs('#formMode').value='edit'; new bootstrap.Modal(qs('#editModal')).show(); }

function openView(empIdEnc){ const id=decodeURIComponent(empIdEnc); const rec=employees.find(r=>r.EmpID==id); if(!rec) return; const body = ` <dl class='row'> <dt class='col-4'>Emp ID</dt><dd class='col-8'>${escapeHtml(rec.EmpID||'')}</dd> <dt class='col-4'>Name</dt><dd class='col-8'>${escapeHtml(rec.Name||'')}</dd> <dt class='col-4'>Gender</dt><dd class='col-8'>${escapeHtml(rec.Gender||'')}</dd> <dt class='col-4'>Address</dt><dd class='col-8'>${escapeHtml(rec.Address||'')}</dd> <dt class='col-4'>Email</dt><dd class='col-8'>${escapeHtml(rec.Email||'')}</dd> <dt class='col-4'>Contact</dt><dd class='col-8'>${escapeHtml(rec.Contact||'')}</dd> </dl>`; alert(body); }

function confirmDelete(empIdEnc){ if(!confirm('هل أنت متأكد من الحذف؟')) return; const id=decodeURIComponent(empIdEnc); fetch(`${API_BASE}?mode=delete&id=${encodeURIComponent(id)}`).then(r=>r.text()).then(txt=>{ if(txt.toLowerCase().includes('deleted')) loadData(); else alert('delete failed'); }).catch(e=>alert('error')) }

qs('#saveBtn').addEventListener('click', ()=>{

  const mode = qs('#formMode').value;

  const payload = {
    mode: mode,   // مهم كي يستقبله Code.gs
    EmpID: qs('#f_empid').value.trim(),
    Name: qs('#f_name').value.trim(),
    Gender: qs('#f_gender').value,
    Address: qs('#f_address').value.trim(),
    Email: qs('#f_email').value.trim(),
    Contact: qs('#f_contact').value.trim(),
    Organization: qs('#f_org').value.trim(),
    Department: qs('#f_dept').value.trim(),
    Position: qs('#f_position').value.trim(),
    Website: qs('#f_website').value.trim()
  };

  fetch(API_BASE, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.text())   // لأن الرد الآن نص وليس JSON
  .then(txt => {

    if (txt.trim().toLowerCase().includes("added") ||
        txt.trim().toLowerCase().includes("updated")) {

      loadData();
      bootstrap.Modal.getInstance(qs('#editModal')).hide();

    } else {
      console.error("Server said:", txt);
      alert("خطأ في العملية");
    }

  })
  .catch(err => {
    console.error(err);
    alert("فشل في الاتصال بالخادم");
  });

});


function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]; }); }

// Logout button
qs('#btnLogout').addEventListener('click', ()=>{ location.reload(); });

</script>
</body>
</html>
